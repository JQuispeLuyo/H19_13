<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                template="./../template/template.xhtml"
                xmlns:p="http://primefaces.org/ui"
                xmlns:h="http://xmlns.jcp.org/jsf/html"  
                xmlns:f="http://xmlns.jcp.org/jsf/core">

    <ui:define name="content">
        <p:growl id="idGrowl" />

        <h:form id="form">
            <h:panelGrid columns="2" >

                <h:outputText value="ID de vendedor: " />
                <h:outputText value="#{ventaDetalleC.vendedor.IDDETASIG}" />

                <h:outputText value="Nombre de vendedor: " />
                <h:outputText value="#{ventaDetalleC.vendedor.NOMPER} #{ventaDetalleC.vendedor.APEPER}" />                     

                <h:outputText value="Fecha de venta: " />
                <h:outputText value="#{ventaDetalleC.venta.FECVEN}">
                    <f:convertDateTime pattern="dd-MMM-yyyy"/>
                </h:outputText>
            </h:panelGrid>
        </h:form>

        <h:form id="formVentaBtns">
            <p:commandButton id="btnNewVenta"
                             value="Nueva venta"
                             update=":frmTblVentaDetall:tblVentaDetTemp @form :idGrowl"
                             actionListener="#{ventaDetalleC.iniciar()}">
            </p:commandButton> 
            <p:commandButton rendered="#{!ventaDetalleC.ventaRealizada}"
                             value="Agregar productos" 
                             update=":idTblEquipo:tblEquipo"
                             oncomplete="PF('dlqwEquipo').show()"/>
            <p:commandButton id="btnVender"
                             rendered="#{!ventaDetalleC.ventaRealizada and loginC.persona.TIPPER == 'V'}"
                             value="Realizar venta"
                             update=":frmTblVentaDetall:tblVentaDetTemp @form :idGrowl"
                             actionListener="#{ventaDetalleC.vender()}">
            </p:commandButton> 
            <p:commandButton rendered="#{ventaDetalleC.ventaRealizada}"
                             id="btnBoleta"
                             widgetVar="btnWVenderBoleta"
                             value="Generar boleta"
                             ajax="false"
                             update=":frmTblVentaDetall:tblVentaDetTemp :idGrowl"
                             actionListener="#{ventaDetalleC.generarBoleta()}">
            </p:commandButton> 
            
            
            <p:blockUI trigger="btnVender"
                       block="formVentaBtns"/>
        </h:form>
        <p:dialog modal="true"
                  closable="false"
                widgetVar="dlqwEquipo" 
                responsive="true">
            <p:outputPanel style="text-align: center" >
                <p:panelGrid columns="1">
                    <h:form id="ventaProd">
                        <p:panelGrid columns="2">
                            <h:outputText value="Descripcion" />
                            <h:outputText value="#{ventaDetalleC.selectEquipo.DESEQUI}"/>

                            <h:outputText value="Precio" />
                            <h:outputText value="#{ventaDetalleC.selectEquipo.PREEQUI}"/>

                            <h:outputText value="Cantidad" />
                            <p:spinner min="1" value="#{ventaDetalleC.ventaDetalle.CANTEQUI}"/>

                            <p:commandButton id="idButtonAddDetalle" 
                                             actionListener="#{ventaDetalleC.agregarVentDet()}" 
                                             update=":frmTblVentaDetall:tblVentaDetTemp @form :idGrowl"
                                             value="Agregar"/>
                            <p:commandButton id="idButtonCerrar"
                                             process="@this"
                                             oncomplete="PF('dlqwEquipo').hide()"
                                             update=":frmTblVentaDetall:tblVentaDetTemp @form :idGrowl"
                                             value="Cerrar">
                                <p:resetInput target="ventaProd"/>
                            </p:commandButton>
                        </p:panelGrid>
                        <p:blockUI trigger="idButtonAddDetalle"
                                   block="ventaProd"/>
                    </h:form>

                    <h:form id="idTblEquipo">
                        <p:dataTable id="tblEquipo"
                                     reflow="true"
                                     value="#{ventaDetalleC.equipoList}"
                                     var="lista" 
                                     rowKey="#{lista.IDEQUI}"
                                     selection="#{ventaDetalleC.selectEquipo}" 
                                     selectionMode="single">
                            <p:column headerText="Descripción" >
                                <h:outputText value="#{lista.DESEQUI}"/>
                            </p:column>

                            <p:column headerText="Precio">
                                <h:outputText value="#{lista.PREEQUI}"/>
                            </p:column>
                            
                            <p:column headerText="Cantidad">
                                <h:outputText value="#{lista.CANTINV}"/>
                            </p:column>
                        </p:dataTable>

                        <p:contextMenu for="tblEquipo">
                            <p:menuitem value="Selecionar" update=":ventaProd idTblEquipo :idGrowl"/>
                        </p:contextMenu>
                    </h:form>
                </p:panelGrid>
            </p:outputPanel>
        </p:dialog>


        <h:form id="frmTblVentaDetall">
            <p:dataTable id="tblVentaDetTemp"
                         var="ventaDetTemp" 
                         resizableColumns="true" 
                         value="#{ventaDetalleC.ventaDetalleListTemp}"
                         resizeMode="expand"
                         rowKey="#{ventaDetTemp.IDDETVENT}"
                         selection="#{ventaDetalleC.selectVentaDetalle}"
                         selectionMode="single">
                <f:facet name="header"></f:facet>
                
                <p:column headerText="Cantidad">
                    <h:outputText value="#{ventaDetTemp.CANTEQUI}"/>
                </p:column>

                <p:column headerText="Descripción">
                    <h:outputText value="#{ventaDetTemp.DESEQUI}"/>
                </p:column>

                <p:column headerText="Precio Unit.">
                    <h:outputText value="S/.#{ventaDetTemp.PREEQUI}"/>
                </p:column>

                <p:column>
                    <h:outputText value="S/.#{ventaDetTemp.IMPORT}"/>
                </p:column>

                <p:columnGroup type="footer">
                    <p:row>
                        <p:column colspan="3" style="text-align:right" footerText="Total:" />
                        <p:column style="text-align:left" footerText="S/.#{ventaDetalleC.total}"/>
                    </p:row>
                </p:columnGroup>
            </p:dataTable>
            <p:contextMenu for="tblVentaDetTemp">
                <p:menuitem value="Modificar"
                            update=":ventaModProd"
                            oncomplete="PF('dlqwModificarDet').show()"/>
                <p:menuitem value="Eliminar" 
                            update="frmTblVentaDetall:tblVentaDetTemp @form"
                            actionListener="#{ventaDetalleC.eliminarVentDet()}"/>
            </p:contextMenu>
        </h:form>

        <p:dialog modal="true"
            widgetVar="dlqwModificarDet" 
            responsive="true">
            <p:outputPanel style="text-align: center" >
                <p:panelGrid columns="1">
                    <h:form id="ventaModProd">
                        <p:panelGrid columns="2">
                            <h:outputText value="Descripcion" />
                            <h:outputText value="#{ventaDetalleC.selectVentaDetalle.DESEQUI}"/>

                            <h:outputText value="Precio" />
                            <h:outputText value="#{ventaDetalleC.selectVentaDetalle.PREEQUI}"/>

                            <h:outputText value="Cantidad" />
                            <p:spinner min="1" value="#{ventaDetalleC.selectVentaDetalle.CANTEQUI}"/>

                            <p:commandButton id="idButtonMdf" 
                                             actionListener="#{ventaDetalleC.modificarVentDet()}" 
                                             oncomplete="if(args &amp;&amp; !args.validationFailed)PF('dlqwModificarDet').hide()"
                                             update=":frmTblVentaDetall:tblVentaDetTemp @form :idGrowl"
                                             value="Modificar"/>
                            
                            <p:commandButton id="idButtonCerrarMdf"
                                             process="@this"
                                             oncomplete="PF('dlqwModificarDet').hide()"
                                             update=":frmTblVentaDetall:tblVentaDetTemp @form :idGrowl"
                                             value="Cerrar">
                                <p:resetInput target="ventaModProd"/>
                            </p:commandButton>
                        </p:panelGrid>
                        <p:blockUI trigger="idButtonCerrarMdf"
                                   block="ventaModProd"/>
                        <p:blockUI trigger="idButtonMdf"
                                   block="ventaModProd"/>
                    </h:form>
                </p:panelGrid>
            </p:outputPanel>
        </p:dialog>
        
    </ui:define>

</ui:composition>
